<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo App</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="initial-page">
        <div class="title">
            <h2>ToDo List App</h2>
        </div>
        <div class="section">
            <div class="container">
                <button class="btn-cad">Cadastrar</button>
            </div>
            <div class="container">
                <button class="btn-login">Login</button>
            </div>
        </div>
    </div>

    <div class="cadastrar">
        <h2>Cadastro</h2>
        <form action="" method="post" class="cad__form">
            <input type="email" name="emailCad" placeholder="Email">
            <input type="password" name="passwordCad" placeholder="Senha">
            <input type="submit" value="Cadastrar">
        </form>
    </div>

    <div class="login">
        <h2>Login</h2>
        <form action="" method="post" class="login__form">
            <input type="email" name="email" placeholder="Email">
            <input type="password" name="password" placeholder="Senha">
            <input type="submit" value="Login">
        </form>
    </div>

    <div class="container-login">
        <div class="tasksList">
            <h1>Tarefas</h1>
            <ul class="tasks">
                <li><span></span></li>
            </ul>
        </div>
        <div class="cad_task">
            <form class="conteiner-login__cadTask">
                <h2>Criar Tarefa</h2>
                <div class="div_form">
                    <label for="task">Tarefa:</label>
                    <textarea name="task"></textarea>
                </div>
                <div class="div_form">
                    <label for="datatime">Data e Hora:</label>
                    <input type="date" name="datatime" id="">
                </div>
                <input type="submit" value="+Tarefa" name="acao">
            </form>
            <div class="btn-logout"><button class="logout">Sair</button> </div>
        </div>

    </div>


    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-firestore.js"></script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAfKUdPBJKjAGPuV3I-u5PztLS-bFtZSB4",
            authDomain: "todolist-a606d.firebaseapp.com",
            projectId: "todolist-a606d",
            storageBucket: "todolist-a606d.appspot.com",
            messagingSenderId: "135648246164",
            appId: "1:135648246164:web:6e4aff4a03d274dace3781"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        let db = firebase.firestore();

        let usuario = null;
        let formLogin = document.querySelector('form.login__form');
        let logout = document.querySelector('.logout');

        let BtnLogin = document.querySelector('.btn-login');
        let BtnCad = document.querySelector('.btn-cad');

        let cadForm = document.querySelector('.cad__form');

        BtnCad.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.container-login').style.display = 'none';
            document.querySelector('.cadastrar').style.display = 'flex';
            document.querySelector('.login').style.display = 'none';
            document.querySelector('.initial-page').style.display = 'none';
        })

        BtnLogin.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.container-login').style.display = 'none';
            document.querySelector('.login').style.display = 'flex';
            document.querySelector('.initial-page').style.display = 'none';
            document.querySelector('.cadastrar').style.display = 'none';
        })


        cadForm.addEventListener('submit', (event) => {
            event.preventDefault();
            let email = document.querySelector('input[name="emailCad"]').value;
            let password = document.querySelector('input[name="passwordCad"]').value;
            if(email == '' || password == ''){
                document.querySelector('input').style.border = '1px solid red';
                document.querySelector('input[name="passwordCad"]').style.border = '1px solid red';
                return;
            }else if(password.length < 6){
                document.querySelector('input[name="passwordCad"]').style.border = '1px solid red';
                alert('A senha deve conter pelo menos 6 digitos');
                return;
            }else if(email.indexOf('@') == -1){
                document.querySelector('input[name="emailCad"]').style.border = '1px solid red';
                return;
            }
            firebase.auth().createUserWithEmailAndPassword(email, password).then((userCredentials) => {
                let user = userCredentials.user;
                document.querySelector('.container-login').style.display = 'flex';
                document.querySelector('.login').style.display = 'none';
                document.querySelector('.cadastrar').style.display = 'none';
                document.querySelector('.initial-page').style.display = 'none';
                console.log(user);
            }).catch((error) => {
                document.querySelector('input').style.border = '1px solid red';
                document.querySelector('input[name="password"]').style.border = '1px solid red';
            })
        })


        formLogin.addEventListener('submit', (event) => {
            event.preventDefault();
            let email = document.querySelector('input[name="email"]').value;
            let password = document.querySelector('input[name="password"]').value;

            firebase.auth().signInWithEmailAndPassword(email, password).then((userCredentials) => {
                let usuario = userCredentials.user;
                document.querySelector('.container-login').style.display = 'flex';
                document.querySelector('.login').style.display = 'none';
                document.querySelector('.cadastrar').style.display = 'none';
                document.querySelector('.initial-page').style.display = 'none';
                console.log(usuario);


            }).catch((error) => {
                document.querySelector('input').style.border = '1px solid red';
                document.querySelector('input[name="password"]').style.border = '1px solid red';
            })

        })

        logout.addEventListener('click', (e) => {
            e.preventDefault();
            firebase.auth().signOut().then(() => {
                document.querySelector('.container-login').style.display = 'none';
                document.querySelector('.login').style.display = 'flex';
                document.querySelector('.initial-page').style.display = 'none';
                document.querySelector('.cadastrar').style.display = 'none';
                formLogin.reset();
            }).catch((error) => {
                console.log(error);
            })
        })


        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                usuario = user;
                document.querySelector('.login').style.display = 'none';
                document.querySelector('.container-login').style.display = 'flex';
                document.querySelector('.initial-page').style.display = 'none';
                document.querySelector('.cadastrar').style.display = 'none';

                db.collection('tasks').where('userId', '==', user.uid).onSnapshot((querySnapshot) => {
                    let list = document.querySelector('.tasks');
                    list.innerHTML = '';
                    let tasks = querySnapshot.docs;
                    tasks = tasks.sort(function(a,b){
                        if(a.data().horario < b.data().horario){
                            return -1;
                        }else{
                            return +1;
                        }
                    })
                    tasks.map((val)=>{
                        list.innerHTML += `<li>${val.data().tarefa} - ${val.data().horario.split(',')[0]} <span id="${val.id}">X</span></li>`
                    })
                    tasks.map((val)=>{
                        if(val.horario.split(',')[0] > new Date().toLocaleDateString('pt-br')){
                            db.collection('tasks').doc(val.target.id).delete();
                        }
                    })
                })
                
            }
        });

        let formTask = document.querySelector('.conteiner-login__cadTask');




        formTask.addEventListener('submit', (event) => {
            event.preventDefault();
            let dateTime = document.querySelector('input[name="datatime"]').value;
            let task = document.querySelector('textarea[name="task"]').value;
            let dateTimeInput = document.querySelector('input[name="datatime"]')
            let taskInput = document.querySelector('textarea[name="task"]')
            let currentDate = new Date().getTime();
            if (dateTime != '' && task != '') {
                if (currentDate < new Date(dateTime).getTime()) {
                    dateTimeInput.style.border = '1px solid black';
                    taskInput.style.border = '1px solid black';
                    db.collection('tasks').add({
                        tarefa: task,
                        horario: new Date(dateTime).toLocaleString('pt-br'),
                        userId: usuario.uid
                    })
                    formTask.reset();
                } else {
                    dateTimeInput.style.border = '1px solid red';
                }
            } else {
                dateTimeInput.style.border = '1px solid red';
                taskInput.style.border = '1px solid red';
            }
        })

        let removeTask = document.querySelector('.tasks');
        removeTask.addEventListener('click', (event) => {
            if (event.target.tagName == 'SPAN') {
                let confDel = confirm('Deseja deletar esta tarefa?');
                if (confDel) {
                    db.collection('tasks').doc(event.target.id).delete();
                }
            }
        })

    </script>
</body>

</html>